<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crecer Labs audio to text</title>
</head>
<body>
    <h1>Cffrecer Labs audio to text</h1>
    <button id="start">Start Streaming</button>
    <button id="stop" disabled>Stop Streaming</button>
    <h2>Received Text:</h2>
    <div id="textOutput"></div>

    <script>
        let audioContext;
        let mediaStream;
        let mediaStreamSource;
        let scriptProcessor;
        let audioWebSocket;
        let textWebSocket;

        const startButton = document.getElementById('start');
        const stopButton = document.getElementById('stop');
        const textOutput = document.getElementById('textOutput');

        startButton.onclick = async () => {
            startButton.disabled = true;
            stopButton.disabled = false;

            try {
                // Get access to the microphone
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Create an audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create a WebSocket connection for audio data
                audioWebSocket = new WebSocket('ws://localhost:8000/ws/bytestream');
                audioWebSocket.binaryType = 'arraybuffer';

                audioWebSocket.onopen = () => {
                    console.log('Audio WebSocket connection established');
                };

                audioWebSocket.onerror = (error) => {
                    console.error('Audio WebSocket error:', error);
                };

                // Create a MediaStreamSource from the mediaStream
                mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);

                // Create a ScriptProcessorNode
                scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

                // Process audio data
                scriptProcessor.onaudioprocess = (audioProcessingEvent) => {
                    const inputBuffer = audioProcessingEvent.inputBuffer;
                    const inputData = inputBuffer.getChannelData(0);
                    
                    // Convert Float32Array to ArrayBuffer
                    const buffer = new ArrayBuffer(inputData.length * 2);
                    const view = new DataView(buffer);
                    
                    for (let i = 0; i < inputData.length; i++) {
                        view.setInt16(i * 2, inputData[i] * 0x7FFF, true); // Convert to 16-bit PCM
                    }

                    // Send the audio data to the WebSocket server
                    if (audioWebSocket.readyState === WebSocket.OPEN) {
                        audioWebSocket.send(buffer);
                    }
                };

                // Connect the MediaStreamSource to the ScriptProcessorNode
                mediaStreamSource.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                // Create a WebSocket connection for text data
                textWebSocket = new WebSocket('ws://localhost:8000/ws/textstream');

                textWebSocket.onopen = () => {
                    console.log('Text WebSocket connection established');
                };

                textWebSocket.onmessage = (event) => {
                    // Display the received text in real-time
                    if(textOutput.innerText.length>1)
                        textOutput.innerText += event.data + '\n';
                        textOutput.scrollTop = textOutput.scrollHeight; // Auto-scroll to the bottom
                };

                textWebSocket.onerror = (error) => {
                    console.error('Text WebSocket error:', error);
                };

            } catch (err) {
                console.error('Error accessing the microphone:', err);
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        };

        stopButton.onclick = () => {
            startButton.disabled = false;
            stopButton.disabled = true;

            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor.onaudioprocess = null;
                scriptProcessor = null;
            }

            if (mediaStreamSource) {
                mediaStreamSource.disconnect();
                mediaStreamSource = null;
            }

            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            if (audioWebSocket) {
                audioWebSocket.close();
                audioWebSocket = null;
            }

            if (textWebSocket) {
                textWebSocket.close();
                textWebSocket = null;
            }

            console.log('Streaming stopped');
        };
    </script>
</body>
</html>
